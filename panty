#!/bin/bash

inotify_event_delay=0.3
debug=1

queue_file=/tmp/xmosh/panty-queue
at_start=$(date '+%N')


function wait_for_x () {
  [ "$debug" -eq 1 ] && echo 'wait_for_x'

  while true
  do
    sleep 1
    &>1 xprop -root > /dev/null && return
  done
}


function initialize_queue_file () {
  [ -e "$queue_file" ] || mkfifo "$queue_file"
}

function pull () {
  local window="$1"

  # xc pull "$window"

  local desktop="$(xdotool get_desktop)"
  xdotool set_desktop_for_window "$window" "$desktop"
}

function main_stocker () {
  wait_for_x

  local window="$(gvim --echo-wid --role 'STOCKING' | head -n 1 | sed 's/.*: //')"

  [ "$debug" -eq 1 ] && echo "spawn: $window"
  echo "$window" > "$queue_file"

  main_stocker
}

function main_summon () {
  local window="$(head -n 1 "$queue_file")"

  pull "$window"

  # Send file names
  [ "$#" -gt 0 ] && gvim --servername 'STOCKING' --remote "$@"

  if [ "$debug" -eq 1 ]
  then
    # Time
    at_summoned=$(date '+%N')
    echo -n 'summon: '
    expr \( $at_summoned - $at_start \) / 1000 / 1000
  fi

  # Stocking becomes panty
  xdotool set_window --role 'PANTY' "$window"
}

function main_daemon () {
  if [ "${#@}" -eq 0 ]
  then
    local targets=(~/.vimrc ~/.vim)
  else
    local targets=("$@")
  fi

  wait_for_x

  [ "$debug" -eq 1 ] && echo "daemon: ${targets[@]}"

  inotifywait -e move,delete,close_write  -r "${targets[@]}"
  sleep "$inotify_event_delay"

  main_kill

  main_daemon "$@"
}

function main_kill () {
  while read window
  do
    xdotool windowkill "$window"
  done < "$queue_file"
}


function main () {
  local sub="$1"
  shift

  initialize_queue_file

  if [ -n "$sub" ] && type "main_$sub" &> /dev/null
  then
    "main_$sub" "$@"
    exit 0
  fi

  exec 2>&1
  echo 'Usage: panty summon <GVIM ARGS>....'
  echo '       panty initialize'
  echo '       panty kill'
  echo '       panty list'
  exit 1
}

main "$@"
